/** ! coupon 2016-08-03 */
function dialogListeners(){$("#used .modal-footer").on("tap",function(){window.location.href=ctx+"/lottery/showBind.html"}),$("#first .styleBtn").on("tap",function(){lenFlows>current?(isConfirm=!0,runLottery()):zero()}),$("#notFirst .styleBtn").on("tap",function(){lenFlows>current?(isConfirm=!0,runLottery()):zero()}),$("#share").on("tap",function(){$(this).modal("hide")}),$(".close-font").on("tap",function(){"false"===shared&&$("#share").modal("show")}),$(".cancel-play").on("tap",function(){lottery.running=!1}),$("#afterShare .styleBtn").on("tap",function(){$("#afterShare").modal("hide")})}function renderStatusData(){getCountAndShared(function(a){remain=a.count,current=a.current,costFlows=a.costFlows,lenFlows=costFlows.length,hasEnoughFlow=a.hasEnoughFlow+"",updateCount(),shared=a.share+""})}function updateCount(){$("#remainCount").html(remain)}function lotteryAOP(){lottery.beforeRun=function(){return zero()?void(lottery.running||(lottery.running=!0,checkIsBind(function(a){current?($("#cost-flow").html(costFlows[current]),$("#notFirst").modal("show")):$("#first").modal("show")}))):!1}}function checkIsBind(a){isBind(function(b){"302"==b.code?window.location.href=ctx+"/lottery/showBind.html":"303"==b.code?$("#used").modal("show"):"202"==b.code?showDialogContent("busy"):a&&a()})}function getCountAndShared(a){$.ajax({url:ctx+"/lottery/shareCount.html?_="+new Date,type:"POST",async:!1,dataType:"json",success:function(b){a&&a(b)}})}function isBind(a){$.ajax({url:ctx+"/lottery/preCheck.html",type:"GET",timeout:5e3,dataType:"json",success:function(b){a&&a(b)},error:function(){showDialogContent("busy")}})}function runLottery(){$.ajax({url:ctx+"/lottery/playAjax.html",type:"GET",timeout:5e3,dataType:"json",success:function(a){return"202"===a.code?void showDialogContent("busy"):(remain--,0>=remain&&(remain=0),updateCount(),isConfirm===!0&&(isConfirm=!1,current++),void(a.winning?lottery.start({index:lotteryMap[a.rankName],done:function(){$("#flow-size").html(a.prizeName),a.prizeName.indexOf("流量")>0?$(".body-flow .tip-font").html(awardMap.AWARD_1):$(".body-flow .tip-font").html(awardMap.AWARD_2),showDialogContent("flow")}}):lottery.start({index:failMap,done:function(){$(".body-failure .tip-font").html(TIP_DIALOG.FAIL_1),showDialogContent("failure")}})))},error:function(){lottery.start({index:failMap,done:function(){showDialogContent("busy")}})}})}function zero(){return 1>remain&&current>=lenFlows?lottery.running?!1:($(".body-zero .tip-font").html(zeroMap[hasEnoughFlow]),showDialogContent("zero"),!1):!0}function showDialogContent(a){$("#turntable-result .modal-content").addClass("hide"),$("#turntable-result .body-"+a).removeClass("hide"),$("#turntable-result").modal("show")}var shared=!1,current=0,remain=0,costFlows=0,lenFlows=0,hasEnoughFlow=!0,bRotate=!1,isConfirm=!1,lotteryMap={"特等奖":0,"一等奖":2,"二等奖":4,"三等奖":6},failMap=1,TIP_DIALOG={FAIL_1:"虽然这次没有中，但梦想<br>还是要有的，要么再来一次？"},awardMap={AWARD_1:"流量直接充入您的账户中，<br>请进入中移流量Plus公众号内查看，谢谢!",AWARD_2:"后台客服人员会在三个工作日内联系您哦。"},zeroMap={"true":"别贪心，今天抽奖次数已经用完<br>了，请明天再来吧！","false":"您中移流量Plus账户中的<br>流量额度不足！明天再来吧！"};$(function(){renderStatusData(),lotteryAOP(),$("#marquee").kxbdMarquee({direction:"up",isEqual:!1,scrollDelay:"30"}),dialogListeners()});